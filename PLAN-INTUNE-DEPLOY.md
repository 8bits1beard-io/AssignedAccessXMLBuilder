# Plan: Direct Intune Deployment from Kiosk Overseer

## Overview

Add the ability to deploy the generated AssignedAccess XML directly to Microsoft Intune as an OMA-URI custom device configuration profile — either via a generated PowerShell script or directly from the browser using MSAL.js.

**Goal:** Eliminate the manual copy-paste workflow (generate XML → open Intune portal → create custom profile → paste XML → assign to group) with a one-click or one-script deployment.

---

## How It Works Today (Manual)

1. User builds config in Kiosk Overseer
2. Downloads XML file
3. Opens Intune portal → Devices → Configuration → Create → Custom
4. Enters profile name, adds OMA-URI row:
   - OMA-URI: `./Vendor/MSFT/AssignedAccess/Configuration`
   - Data type: String (XML)
   - Value: paste XML
5. Assigns profile to a device group
6. Waits for devices to sync

Steps 3–6 are what we're automating.

---

## Technical Foundation

### The Graph API Call

```
POST https://graph.microsoft.com/v1.0/deviceManagement/deviceConfigurations
```

**Payload:**
```json
{
    "@odata.type": "#microsoft.graph.windows10CustomConfiguration",
    "displayName": "Kiosk Config - <configName>",
    "description": "Deployed via Kiosk Overseer",
    "omaSettings": [{
        "@odata.type": "#microsoft.graph.omaSettingStringXml",
        "displayName": "AssignedAccess Configuration",
        "description": "Windows 11 Assigned Access XML",
        "omaUri": "./Vendor/MSFT/AssignedAccess/Configuration",
        "fileName": "AssignedAccessConfiguration.xml",
        "value": "<base64-encoded UTF-8 XML>"
    }]
}
```

**Critical detail:** The OMA setting type must be `omaSettingStringXml` (not `omaSettingString`). The `value` must be the XML encoded as a base64 string of its UTF-8 byte representation. The `fileName` field is required.

### Group Assignment (after profile creation)

```
POST https://graph.microsoft.com/v1.0/deviceManagement/deviceConfigurations/{profileId}/assign
```

```json
{
    "assignments": [{
        "@odata.type": "#microsoft.graph.deviceConfigurationAssignment",
        "target": {
            "@odata.type": "#microsoft.graph.groupAssignmentTarget",
            "groupId": "<entra-group-guid>"
        }
    }]
}
```

### Required Permission

`DeviceManagementConfiguration.ReadWrite.All` (delegated). Requires **admin consent** — a regular user cannot self-consent to this scope. The signed-in user must also hold an Intune administrator role.

For group lookup (optional): `Group.Read.All`

---

## Two Implementation Approaches

### Approach A: PowerShell Script Export

**What:** A new export button "Deploy to Intune (Script)" that downloads a `.ps1` file with the XML baked in. The admin runs it locally.

**Auth method:** `Connect-MgGraph` interactive browser login (or device code flow).

**Pros:**
- Zero web infrastructure needed — just a generated script
- IT admins trust reviewable PowerShell scripts
- Works within existing export pattern (like All-In-One Script)
- No Azure AD app registration required (uses Microsoft's built-in Graph PowerShell client ID `14d82eec-204b-4c2f-b7e8-296a70dab67e`)
- Can include group assignment prompts

**Cons:**
- Requires `Microsoft.Graph.Authentication` module installed
- Extra step (download script → run script)
- User must have PowerShell access

### Approach B: In-Browser MSAL.js Deployment

**What:** A "Deploy to Intune" button in the Summary tab that authenticates via popup and creates the profile directly from the browser.

**Auth method:** MSAL.js v2.35.0 popup flow with PKCE.

**Pros:**
- Seamless one-click experience — no script, no download
- Stays in the tool
- Can show real-time feedback (created, assigned, done)

**Cons:**
- Requires an Azure AD app registration (either user creates one, or we publish a multi-tenant app)
- Admin consent flow adds friction on first use per tenant
- More code to maintain (auth state, token refresh, error handling)
- MSAL.js adds ~70KB to page load

---

## Recommended Implementation Order

**Phase 1: PowerShell script** — Ship fast, low risk, zero infrastructure.
**Phase 2: In-browser MSAL.js** — Better UX, but needs app registration and more code.

Both phases can coexist as separate export options.

---

## Phase 1: PowerShell Script Export

### Generated Script Structure

```powershell
#Requires -Modules Microsoft.Graph.Authentication

<#
.SYNOPSIS
    Deploys an AssignedAccess kiosk configuration to Microsoft Intune.
    Generated by Kiosk Overseer (kioskoverseer.com)
.DESCRIPTION
    Creates a custom OMA-URI device configuration profile in Intune
    containing the AssignedAccess XML for Windows 11 kiosk mode.
    Optionally assigns the profile to a device group.
.NOTES
    Profile: <configName>
    Generated: <timestamp>
    Requires: Microsoft.Graph.Authentication module
              Intune Administrator role
#>

param(
    [string]$ProfileName = "<configName from tool>",
    [string]$GroupId,
    [switch]$UseDeviceCode
)

# ── Embedded XML (base64) ──────────────────────────────────────────────
$XmlBase64 = @"
<base64-encoded XML>
"@

# ── Verify Prerequisites ──────────────────────────────────────────────
$graphModule = Get-Module -ListAvailable -Name Microsoft.Graph.Authentication
if (-not $graphModule) {
    Write-Host "Microsoft.Graph.Authentication module not found." -ForegroundColor Red
    Write-Host "Install it with: Install-Module Microsoft.Graph.Authentication -Scope CurrentUser"
    exit 1
}

# ── Authenticate ───────────────────────────────────────────────────────
$scopes = @("DeviceManagementConfiguration.ReadWrite.All")
if ($GroupId) {
    $scopes += "Group.Read.All"
}

Write-Host "`n== Kiosk Overseer - Intune Deployment ==" -ForegroundColor Cyan
Write-Host "Profile: $ProfileName"
Write-Host "Connecting to Microsoft Graph...`n"

$connectParams = @{ Scopes = $scopes; NoWelcome = $true }
if ($UseDeviceCode) {
    $connectParams.UseDeviceCode = $true
}

try {
    Connect-MgGraph @connectParams
} catch {
    Write-Host "Authentication failed: $_" -ForegroundColor Red
    exit 1
}

# ── Verify Connection ─────────────────────────────────────────────────
$context = Get-MgContext
if (-not $context) {
    Write-Host "Not connected to Microsoft Graph." -ForegroundColor Red
    exit 1
}
Write-Host "Authenticated as: $($context.Account)" -ForegroundColor Green
Write-Host "Tenant: $($context.TenantId)`n"

# ── Create Configuration Profile ──────────────────────────────────────
$body = @{
    "@odata.type" = "#microsoft.graph.windows10CustomConfiguration"
    displayName   = $ProfileName
    description   = "Kiosk configuration deployed via Kiosk Overseer"
    omaSettings   = @(
        @{
            "@odata.type" = "#microsoft.graph.omaSettingStringXml"
            displayName   = "AssignedAccess Configuration"
            description   = "Windows 11 Assigned Access kiosk XML"
            omaUri        = "./Vendor/MSFT/AssignedAccess/Configuration"
            fileName      = "AssignedAccessConfiguration.xml"
            value         = $XmlBase64
        }
    )
}

Write-Host "Creating Intune configuration profile..." -ForegroundColor Yellow

try {
    $result = Invoke-MgGraphRequest `
        -Uri "https://graph.microsoft.com/v1.0/deviceManagement/deviceConfigurations" `
        -Method POST `
        -Body $body
    $profileId = $result.id
    Write-Host "Profile created successfully!" -ForegroundColor Green
    Write-Host "  Profile ID: $profileId"
    Write-Host "  Display Name: $ProfileName"
} catch {
    Write-Host "Failed to create profile: $_" -ForegroundColor Red
    Disconnect-MgGraph | Out-Null
    exit 1
}

# ── Assign to Group (optional) ────────────────────────────────────────
if (-not $GroupId) {
    Write-Host "`nNo group specified. To assign, re-run with -GroupId <guid>" -ForegroundColor Yellow
    Write-Host "Or assign manually in the Intune portal.`n"
} else {
    Write-Host "`nAssigning profile to group: $GroupId" -ForegroundColor Yellow

    $assignBody = @{
        assignments = @(
            @{
                "@odata.type" = "#microsoft.graph.deviceConfigurationAssignment"
                target = @{
                    "@odata.type" = "#microsoft.graph.groupAssignmentTarget"
                    groupId = $GroupId
                }
            }
        )
    }

    try {
        Invoke-MgGraphRequest `
            -Uri "https://graph.microsoft.com/v1.0/deviceManagement/deviceConfigurations/$profileId/assign" `
            -Method POST `
            -Body $assignBody | Out-Null
        Write-Host "Profile assigned to group successfully!" -ForegroundColor Green
    } catch {
        Write-Host "Failed to assign profile: $_" -ForegroundColor Red
        Write-Host "The profile was created but not assigned. Assign manually in Intune."
    }
}

# ── Cleanup ────────────────────────────────────────────────────────────
Disconnect-MgGraph | Out-Null
Write-Host "`nDone. The profile will apply when target devices next sync with Intune." -ForegroundColor Cyan
```

### Changes Required

**Files:** `app.js`, `config.js`, `index.html`, `styles.css`

1. **`app.js`** — Add `downloadIntuneScript()` function:
   - Generates the XML via `generateXml()`
   - Base64-encodes it: `btoa(unescape(encodeURIComponent(xml)))` (handles UTF-8)
   - Interpolates into the PowerShell template above
   - Downloads as `Deploy-<configName>.intune.ps1`

2. **`config.js`** — Register `downloadIntuneScript` in `actionHandlers`

3. **`index.html`** — Add button to export panel:
   ```html
   <button type="button" class="btn-secondary" data-action="downloadIntuneScript"
       data-export="intune" title="PowerShell script that creates an Intune OMA-URI profile">
       Intune Deploy Script
   </button>
   ```

4. **`styles.css`** — No changes needed (uses existing button styles)

### Edge Cases to Handle

- **Empty XML / validation errors**: Run validation before generating; warn if errors exist
- **Config name sanitization**: Strip special characters from profile name
- **Large XML**: Base64 encoding increases size ~33%; shouldn't be an issue for AssignedAccess XML (typically <10KB)
- **Module not installed**: Script checks for `Microsoft.Graph.Authentication` on launch

---

## Phase 2: In-Browser MSAL.js Deployment

### Architecture

```
User clicks "Deploy to Intune"
        │
        ▼
┌─────────────────────┐
│ Check: Tenant ID &  │
│ Client ID configured│──No──▶ Show setup instructions
│ in localStorage?    │
└────────┬────────────┘
         │ Yes
         ▼
┌─────────────────────┐
│ MSAL.js: acquire    │
│ token (silent first, │──Fail──▶ loginPopup()
│ then interactive)   │
└────────┬────────────┘
         │ Token acquired
         ▼
┌─────────────────────┐
│ POST to Graph API:  │
│ create profile      │
└────────┬────────────┘
         │ Profile created
         ▼
┌─────────────────────┐
│ Optional: list      │
│ groups, let user     │
│ pick assignment      │
└────────┬────────────┘
         │
         ▼
┌─────────────────────┐
│ POST to Graph API:  │
│ assign to group     │
└─────────────────────┘
```

### Prerequisites for Users

Before first use, the tenant admin must:

1. **Create an Azure AD app registration** (or we publish a multi-tenant one):
   - Supported account types: "Accounts in any organizational directory" (multi-tenant)
   - Platform: Single-page application (SPA)
   - Redirect URI: `https://kioskoverseer.com` (or localhost for dev)
   - API permissions: `Microsoft.Graph > Delegated > DeviceManagementConfiguration.ReadWrite.All`
   - Grant admin consent for the tenant

2. **Enter the Client ID** in Kiosk Overseer's settings (stored in localStorage)

If we publish our own multi-tenant app registration, users skip step 1 and only need their admin to consent.

### MSAL.js Integration

**CDN (no build step):**
```html
<script src="https://alcdn.msauth.net/browser/2.35.0/js/msal-browser.min.js"
    integrity="sha384-PARf28kmic36Ve+O3DnUerRXFtOQ7ZDqRDGpLcbljly5/N39T2OV3kt3QsWOKeAX"
    crossorigin="anonymous">
</script>
```

**Configuration:**
```javascript
const msalConfig = {
    auth: {
        clientId: localStorage.getItem('intuneClientId'),
        authority: 'https://login.microsoftonline.com/organizations',
        redirectUri: window.location.origin
    },
    cache: { cacheLocation: 'sessionStorage' }
};
```

**Token flow:**
```javascript
// Silent first → popup fallback
async function getIntuneToken() {
    const scopes = ['https://graph.microsoft.com/DeviceManagementConfiguration.ReadWrite.All'];
    const account = msalInstance.getAllAccounts()[0];
    try {
        return (await msalInstance.acquireTokenSilent({ scopes, account })).accessToken;
    } catch (e) {
        if (e instanceof msal.InteractionRequiredAuthError) {
            return (await msalInstance.acquireTokenPopup({ scopes })).accessToken;
        }
        throw e;
    }
}
```

### Changes Required

**New file:** `intune.js` (~150-200 lines)

Contents:
- `initIntune()` — Initialize MSAL instance if client ID is configured
- `isIntuneConfigured()` — Check if client ID exists in localStorage
- `showIntuneSetup()` — Show modal with app registration instructions + client ID input
- `deployToIntune()` — Main flow: validate → authenticate → create profile → assign
- `createIntuneProfile(token, xml, profileName)` — POST to Graph API
- `assignIntuneProfile(token, profileId, groupId)` — POST assignment
- `listIntuneGroups(token)` — GET groups for picker
- `handleGraphError(response)` — Parse Graph API errors into user-friendly messages

**`index.html`:**
- Add MSAL.js CDN script tag (conditional load — only if intune feature is used)
- Add `<script src="intune.js?v=..."></script>` to load order (after config.js)
- Add "Deploy to Intune" button on Summary tab
- Add Intune setup modal (client ID input, instructions)
- Add group picker modal (list of groups to assign to)

**`config.js`:**
- Register new action handlers: `deployToIntune`, `showIntuneSetup`, `hideIntuneSetup`
- Save/load intune client ID in config snapshots (optional)

**`styles.css`:**
- Status indicators for deploy progress (connecting → creating → assigning → done)

### UX Flow (Summary Tab)

```
┌──────────────────────────────────────────┐
│ EXPORT                                    │
│ ┌──────────┐ ┌──────────┐ ┌──────────┐  │
│ │ Intune   │ │ Local    │ │ Prov.Pkg │  │
│ └──────────┘ └──────────┘ └──────────┘  │
│                                           │
│ "Download the XML and paste it into..."  │
│                                           │
│ ┌─────────────────────────────────────┐  │
│ │        Download XML                  │  │
│ └─────────────────────────────────────┘  │
│ ┌──────┐ ┌──────────┐ ┌──────────────┐  │
│ │Copy  │ │All-In-One│ │Intune Deploy │  │
│ │XML   │ │Script    │ │Script        │  │
│ └──────┘ └──────────┘ └──────────────┘  │
│                                           │
│ ── OR ──                                 │
│                                           │
│ ┌─────────────────────────────────────┐  │
│ │  ⚡ Deploy to Intune (Browser)      │  │
│ │  Sign in and create profile         │  │
│ └─────────────────────────────────────┘  │
│ ┌─────┐                                  │
│ │ ⚙   │ Configure Intune Connection     │
│ └─────┘                                  │
└──────────────────────────────────────────┘
```

### Deploy Progress UI

When "Deploy to Intune (Browser)" is clicked:

```
┌─────────────────────────────────────────┐
│ Deploy to Intune                    [×] │
│─────────────────────────────────────────│
│                                         │
│ ✓ Validating configuration              │
│ ✓ Authenticated as admin@contoso.com    │
│ ● Creating profile...                   │
│ ○ Assigning to group                    │
│                                         │
│ Profile: Lobby Kiosk - Edge Fullscreen  │
│                                         │
│ ┌──── Assign to Group ───────────────┐  │
│ │ ▼ Select a group...               │  │
│ │   Kiosk Devices                    │  │
│ │   Lobby Terminals                  │  │
│ │   Reception Tablets                │  │
│ └────────────────────────────────────┘  │
│                                         │
│          [Skip]    [Assign & Finish]    │
└─────────────────────────────────────────┘
```

---

## Multi-Tenant App Registration Decision

### Option 1: User Brings Their Own App Registration

- User follows our step-by-step guide to create an app registration in their tenant
- Enters Client ID into Kiosk Overseer
- Most secure: app registration is owned by the customer
- Most friction: requires Azure AD admin access to set up

### Option 2: We Publish a Multi-Tenant App

- Register an app in our own Azure AD tenant with `organizations` audience
- Users just enter our Client ID (or it's hardcoded)
- Their tenant admin must consent via an admin consent URL
- Least friction for users
- We take on responsibility: maintaining the app registration, responding to Microsoft reviews
- The permission (`DeviceManagementConfiguration.ReadWrite.All`) is sensitive; Microsoft may flag it during publisher verification

### Recommendation

**Start with Option 1** (user brings their own). Provide a clear setup guide with screenshots. This avoids the operational burden of managing a public app registration and is more appropriate for an open-source tool.

**Consider Option 2 later** if there's demand and we're willing to go through Microsoft's publisher verification process.

---

## Security Considerations

1. **PowerShell script contains XML only** — No credentials, tokens, or secrets are embedded. Auth happens at runtime via interactive login.

2. **Base64 is encoding, not encryption** — The XML in the script is trivially decodable. This is fine; AssignedAccess XML contains no secrets (just app paths, profile GUIDs, user accounts).

3. **MSAL.js tokens in sessionStorage** — Cleared when tab closes. Acceptable for an admin tool. Could use `memoryStorage` for higher security (tokens lost on refresh).

4. **Admin consent is required** — The `DeviceManagementConfiguration.ReadWrite.All` permission cannot be self-consented by regular users. This is a natural guardrail.

5. **Content Security Policy** — If adding MSAL.js, update CSP (if one exists) to allow:
   - `script-src`: `https://alcdn.msauth.net`
   - `connect-src`: `https://login.microsoftonline.com https://graph.microsoft.com`

6. **SRI hash** — Always use subresource integrity when loading MSAL.js from CDN.

7. **No client secret** — SPA applications are public clients; there is no secret to leak. PKCE protects the auth code exchange.

---

## Graph API Throttling

Intune Graph API limits (per app per tenant):
- **Write operations** (POST/PUT/PATCH/DELETE): 100 per 20 seconds
- **All operations**: 1000 per 20 seconds

For Kiosk Overseer, this is irrelevant — we're making 1-2 API calls total (create profile + assign). But the code should handle HTTP 429 gracefully:

```javascript
if (response.status === 429) {
    const retryAfter = response.headers.get('Retry-After') || 5;
    // Wait and retry
}
```

---

## Implementation Order

```
Phase 1: PowerShell Script Export
  1a. Add downloadIntuneScript() to app.js              ~60 lines
  1b. Add button to export panel in index.html           ~3 lines
  1c. Register handler in config.js                      ~1 line
  1d. Wire into guided export (Intune method)            ~0 lines (already data-export="intune")
  1e. Test: generate script, run against test tenant     manual
  Version bump after completion

Phase 2: In-Browser MSAL.js (separate milestone)
  2a. Create intune.js module                            ~200 lines
  2b. Add MSAL.js CDN script tag                         ~5 lines
  2c. Add Intune setup modal (client ID config)          ~40 lines HTML
  2d. Add deploy progress modal                          ~50 lines HTML
  2e. Add group picker UI                                ~30 lines HTML
  2f. CSS for deploy progress states                     ~30 lines
  2g. Register handlers in config.js                     ~5 lines
  2h. Add setup guide page (or section in deploy modal)  ~100 lines HTML
  2i. Test: end-to-end deploy from browser               manual
  Version bump after completion
```

---

## Verification

### Phase 1 (PowerShell Script)
1. Generate an Intune deploy script from a valid config
2. Inspect script: verify base64 XML decodes correctly
3. Run script in PowerShell 7 with Graph module installed
4. Verify profile appears in Intune portal with correct OMA-URI and XML
5. Run with `-GroupId` parameter; verify assignment applies
6. Run without Graph module installed; verify helpful error message
7. Run with `-UseDeviceCode` flag; verify device code flow works

### Phase 2 (MSAL.js Browser)
1. Configure client ID in settings
2. Click "Deploy to Intune" → verify popup login works
3. Verify profile creation succeeds and shows in Intune portal
4. Verify group picker lists correct groups
5. Verify assignment works
6. Test with expired/revoked token → verify re-auth flow
7. Test without admin consent → verify helpful error message
8. Test on kioskoverseer.com (production redirect URI)
9. Test both themes (Fallout and Fluent)

---

## Open Questions

1. **Should the PowerShell script support updating an existing profile?** Could check for a profile with the same display name and offer to update instead of creating a duplicate. Adds complexity but prevents profile sprawl.

2. **Should the tool store the last-used Group ID?** Would streamline repeat deployments. Could save in localStorage alongside client ID.

3. **Should we support applicability rules in the beta API?** The beta endpoint allows `deviceManagementApplicabilityRuleOsEdition` to restrict the profile to Windows 11 Enterprise/Education only. This would prevent accidental deployment to unsupported editions.

4. **Should the generated profile name include a timestamp?** Helps distinguish multiple deployments. Could use format: `Kiosk Overseer - <configName> (YYYY-MM-DD)`.

5. **Should we generate a removal script too?** A companion script that finds and removes the Intune profile by name. Useful for testing/cleanup.
